name: Benchmark

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, labeled]

jobs:
  benchmark:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'run-benchmarks')

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run benchmarks
      run: |
        python benchmarks/run_all_benchmarks.py --output results.json

    - name: Compare with baseline
      run: |
        python benchmarks/compare_benchmarks.py --current results.json --baseline benchmarks/baseline.json

    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: results.json

    - name: Comment PR with results
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const results = JSON.parse(fs.readFileSync('results.json', 'utf8'));
          const comment = `## Benchmark Results\n\n${JSON.stringify(results, null, 2)}`;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
